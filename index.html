<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ford OT Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }

        /* Mobile Bottom Nav Shadow */
        .bottom-nav {
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Card Stylings */
        .app-card {
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
        }

        /* Floating Action Button */
        .fab {
            box-shadow: 0 8px 24px rgba(0, 52, 120, 0.3);
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        /* Custom Scrollbar for Heatmap */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Modal Animation */
        #entry-modal {
            transition: transform 0.3s ease-out, opacity 0.3s;
        }
        .modal-hidden {
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
        }

        .day-input-circle {
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: #f8fafc;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="bg-[#003478] text-white p-4 pt-6 shrink-0" id="header-nav">
        <div class="flex justify-between items-center max-w-5xl mx-auto w-full">
            <div>
                <p class="text-[10px] font-black opacity-60 uppercase tracking-widest">Ford OT Portal</p>
                <h1 class="text-xl font-extrabold" id="header-date-title">Loading...</h1>
            </div>
            <div class="bg-white/10 p-2 rounded-xl text-right">
                <p class="text-[10px] font-bold opacity-60 uppercase">Year Budget</p>
                <p class="text-sm font-black" id="stat-annual-budget">$0</p>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto pb-32 p-4">
        <div class="max-w-5xl mx-auto space-y-4">
            
            <div class="flex items-center justify-between gap-2 bg-white p-3 rounded-2xl border border-slate-200">
                <button onclick="changeWeek(-1)" class="p-3 hover:bg-slate-100 rounded-lg font-bold text-lg">◀</button>
                <div class="text-center flex-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider" id="display-week-label">WEEK 01</span>
                    <p class="text-sm font-black text-[#003478]" id="display-range-label">Jan 1 - Jan 7</p>
                </div>
                <button onclick="changeWeek(1)" class="p-3 hover:bg-slate-100 rounded-lg font-bold text-lg">▶</button>
                <div class="flex gap-1 items-center border-l border-slate-200 pl-3">
                    <select id="jump-year" onchange="jumpToWeek()" class="p-2 rounded-lg bg-white border border-slate-300 text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#003478] cursor-pointer min-w-16">
                    </select>
                    <select id="jump-week" onchange="jumpToWeek()" class="p-2 rounded-lg bg-white border border-slate-300 text-xs font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#003478] cursor-pointer min-w-20">
                    </select>
                </div>
            </div>

            <div id="view-worksheet" class="space-y-4">
                <div class="app-card p-4">
                    <label class="flex items-center gap-2 mb-3">
                        <span class="text-xs font-bold text-slate-500 uppercase">Select Year:</span>
                        <select id="worksheet-year-selector" onchange="switchToYear()" class="p-2 rounded-lg bg-slate-50 border border-slate-300 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-[#003478]"></select>
                    </label>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="app-card p-4">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Target ($)</p>
                        <p class="text-lg font-extrabold text-emerald-600" id="stat-week-target">$0</p>
                    </div>
                    <div class="app-card p-4">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Spent ($)</p>
                        <p class="text-lg font-extrabold text-slate-800" id="stat-week-actual">$0</p>
                    </div>
                </div>

                <div class="app-card overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                        <h3 class="text-xs font-black text-slate-500 uppercase tracking-tighter">Weekly Heatmap</h3>
                        <span class="text-[10px] font-bold bg-[#003478] text-white px-2 py-1 rounded">By Supervisor</span>
                    </div>
                    <div class="overflow-x-auto hide-scrollbar" id="heatmap-container">
                        </div>
                </div>
            </div>

            <div id="view-settings" class="hidden space-y-4">
                <div class="app-card p-6">
                    <h3 class="font-black mb-4 text-lg">Budget Settings</h3>
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <input type="number" id="new-year-input" placeholder="New Year" class="flex-1 p-3 bg-slate-50 rounded-xl font-bold text-lg border-none focus:ring-2 focus:ring-[#003478]" min="2020" max="2050">
                            <button onclick="addNewYear()" class="bg-[#003478] text-white px-4 rounded-xl font-black whitespace-nowrap">Add Year</button>
                        </div>
                        <label class="block">
                            <span class="text-xs font-bold text-slate-500 uppercase">Select Year</span>
                            <select id="settings-year-selector" onchange="updateBudgetForm()" class="w-full mt-2 p-3 bg-slate-50 rounded-xl font-bold text-lg border-none focus:ring-2 focus:ring-[#003478]">
                            </select>
                        </label>
                        <label class="block">
                            <span class="text-xs font-bold text-slate-500 uppercase">Annual Budget ($)</span>
                            <input type="number" id="settings-budget-input" onchange="saveBudgetForYear()" class="w-full mt-2 p-3 bg-slate-50 rounded-xl font-bold text-lg border-none focus:ring-2 focus:ring-[#003478]">
                        </label>
                        <label class="block">
                            <span class="text-xs font-bold text-slate-500 uppercase">1st Day of Budget Year</span>
                            <input type="date" id="settings-week-start" onchange="saveBudgetForYear()" class="w-full mt-2 p-3 bg-slate-50 rounded-xl font-bold text-sm border-none focus:ring-2 focus:ring-[#003478]">
                        </label>
                    </div>
                </div>

                <div class="app-card p-6">
                    <h3 class="font-black mb-4 text-lg">Organization</h3>
                    <div class="space-y-3 mb-4">
                        <div class="flex gap-2">
                            <input type="text" id="new-ll5" placeholder="New Manager Name" class="flex-1 p-3 bg-slate-50 rounded-xl border-none font-bold focus:ring-2 focus:ring-[#003478]">
                            <button onclick="addLL5()" class="bg-[#003478] text-white px-4 rounded-xl font-black">Add</button>
                        </div>
                    </div>
                    <div id="settings-hierarchy" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </main>

    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-20 shrink-0 z-40">
        <button onclick="switchView('worksheet')" class="flex flex-col items-center gap-1 text-[#003478]">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <span class="text-[10px] font-extrabold uppercase">Home</span>
        </button>
        <div class="w-12"></div> <button onclick="switchView('settings')" class="flex flex-col items-center gap-1 text-slate-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
            <span class="text-[10px] font-extrabold uppercase">Settings</span>
        </button>
    </nav>

    <button onclick="openModal()" class="fab fixed bottom-8 left-1/2 -translate-x-1/2 w-16 h-16 bg-[#003478] text-white rounded-full flex items-center justify-center z-50">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
    </button>

    <div id="entry-modal" class="modal-hidden fixed inset-0 bg-black/60 z-[60] flex flex-col justify-end">
        <div class="bg-white rounded-t-[32px] flex flex-col max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 shrink-0">
                <h2 class="text-xl font-black text-slate-800">New OT Entry</h2>
                <button onclick="closeModal()" class="text-slate-400 text-2xl font-bold">×</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-5">
                    <div class="grid grid-cols-1 gap-4">
                        <select id="sel-ll5" onchange="updateLL6Dropdown()" class="w-full p-4 bg-slate-100 rounded-2xl font-bold border-none"></select>
                        <select id="sel-ll6" onchange="updateEmployeeDropdown()" class="w-full p-4 bg-slate-100 rounded-2xl font-bold border-none"></select>
                        <select id="sel-emp" class="w-full p-4 bg-slate-50 border-2 border-[#003478] rounded-2xl font-black"></select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="in-prog" placeholder="Program" class="p-4 bg-slate-100 rounded-2xl font-bold border-none">
                        <input type="text" id="in-loc" placeholder="Location" class="p-4 bg-slate-100 rounded-2xl font-bold border-none">
                    </div>

                    <input type="text" id="in-reason" placeholder="Reason (e.g. Critical Work)" class="w-full p-4 bg-slate-100 rounded-2xl font-bold border-none">

                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-3 ml-1">Daily Hours (Sun - Sat)</p>
                        <div class="grid grid-cols-4 sm:grid-cols-7 gap-2" id="modal-days-container"></div>
                    </div>
                </div>
            </div>

            <div class="border-t border-slate-200 p-6 shrink-0 bg-white">
                <button onclick="addEntry()" class="w-full bg-[#003478] text-white py-5 rounded-2xl font-black text-lg shadow-xl shadow-blue-900/20 active:scale-95 transition">
                    Submit Entry
                </button>
            </div>
        </div>
    </div>

    <script>
        let state = {
            budgetsByYear: { "2026": 1000000 },
            weekStartDates: { "2026": "2026-01-01" },
            rate: 55,
            viewOffset: 0,
            ll5s: [
                { name: "Damian Off", ll6s: [
                    { name: "Rick Adamo", employees: ["John Doe", "Jane Smith"] },
                    { name: "Dave Huddle", employees: ["Staff A", "Staff B"] }
                ]},
                { name: "Raju V.", ll6s: [
                    { name: "Supervisor X", employees: ["Team member"] }
                ]}
            ],
            entries: []
        };

        const DAYS = ['SUN','MON','TUE','WED','THU','FRI','SAT'];

        function init() {
            const saved = localStorage.getItem('ford_ot_v3_mobile');
            if (saved) state = JSON.parse(saved);
            
            renderModalDays();
            populateDropdowns();
            populateWorksheetYearSelector();
            populateJumpSelectors();
            refreshUI();
            switchView('worksheet');
        }

        function populateWorksheetYearSelector() {
            const yearSel = document.getElementById('worksheet-year-selector');
            yearSel.innerHTML = Object.keys(state.budgetsByYear).sort().map(y => 
                `<option value="${y}">${y}</option>`
            ).join('');
            const currentYear = new Date().getFullYear();
            yearSel.value = state.budgetsByYear[currentYear] ? currentYear : Object.keys(state.budgetsByYear)[0];
        }

        function switchToYear() {
            const selectedYear = parseInt(document.getElementById('worksheet-year-selector').value);
            // Jump to Week 1 of selected year
            let week1Start;
            if (state.weekStartDates[selectedYear]) {
                const parts = state.weekStartDates[selectedYear].split('-');
                week1Start = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            } else {
                week1Start = new Date(selectedYear, 0, 1);
            }
            const today = new Date();
            const currentSunday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            currentSunday.setDate(currentSunday.getDate() - currentSunday.getDay());
            state.viewOffset = Math.round((week1Start - currentSunday) / (86400000 * 7));
            refreshUI();
        }

        function renderModalDays() {
            const container = document.getElementById('modal-days-container');
            container.innerHTML = DAYS.map((d, i) => `
                <div class="day-input-circle">
                    <span class="text-[10px] font-black text-slate-400 mb-1">${d}</span>
                    <input type="number" id="hrs-${i}" value="0" class="w-full bg-transparent text-center font-black text-lg focus:outline-none">
                </div>
            `).join('');
        }

        function refreshUI() {
            const week = getWeekData(state.viewOffset);
            
            document.getElementById('header-date-title').innerText = `${week.year}`;
            document.getElementById('display-week-label').innerText = `WEEK ${week.weekNum} OF ${week.year}`;
            document.getElementById('display-range-label').innerText = week.range;
            document.getElementById('set-rate').value = state.rate;
            document.getElementById('worksheet-year-selector').value = week.year;

            const annualBudget = state.budgetsByYear[week.year] || 0;
            const spentInYear = state.entries.filter(e => e.weekKey.startsWith(week.year)).reduce((s, e) => s + e.cost, 0);
            const spentThisWeek = state.entries.filter(e => e.weekKey === week.key).reduce((s, e) => s + e.cost, 0);
            
            document.getElementById('stat-annual-budget').innerText = `$${annualBudget.toLocaleString()}`;
            document.getElementById('stat-annual-remain').innerText = `$${(annualBudget - spentInYear).toLocaleString()}`;
            document.getElementById('stat-week-target').innerText = `$${(annualBudget / 52).toLocaleString(undefined, {maximumFractionDigits:0})}`;
            document.getElementById('stat-week-actual').innerText = `$${spentThisWeek.toLocaleString()}`;

            populateJumpSelectors();
            renderHeatmap(week.key);
        }

        function getWeekData(offset) {
            const today = new Date();
            let d = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            d.setDate(d.getDate() + (offset * 7));
            
            const currentDate = new Date(d);
            const year = currentDate.getFullYear();
            
            // Get the Week 1 start date for this year - parse safely to avoid timezone offset
            let week1Start;
            if (state.weekStartDates[year]) {
                const parts = state.weekStartDates[year].split('-');
                week1Start = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            } else {
                week1Start = new Date(year, 0, 1);
            }
            
            // Calculate days from Week 1 start
            const daysDiff = Math.floor((currentDate - week1Start) / (86400000));
            let weekNum = Math.floor(daysDiff / 7) + 1;
            
            // If before Week 1 start, we're in the previous year's last week
            if (daysDiff < 0) {
                const prevYear = year - 1;
                let prevWeek1Start;
                if (state.weekStartDates[prevYear]) {
                    const parts = state.weekStartDates[prevYear].split('-');
                    prevWeek1Start = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                } else {
                    prevWeek1Start = new Date(prevYear, 0, 1);
                }
                const yearEnd = new Date(prevYear, 11, 31);
                const totalDays = Math.floor((yearEnd - prevWeek1Start) / (86400000));
                weekNum = Math.floor(totalDays / 7) + 1;
                return getWeekData(offset - Math.ceil(daysDiff / 7));
            }
            
            const sun = new Date(week1Start);
            sun.setDate(week1Start.getDate() + (weekNum - 1) * 7);
            const sat = new Date(sun);
            sat.setDate(sat.getDate() + 6);
            
            return { 
                sun, sat, weekNum, year, 
                key: `${year}-W${String(weekNum).padStart(2, '0')}`,
                range: `${sun.toLocaleDateString('en-US', {month:'short', day:'numeric'})} - ${sat.toLocaleDateString('en-US', {month:'short', day:'numeric'})}`
            };
        }

        function renderHeatmap(weekKey) {
            const container = document.getElementById('heatmap-container');
            let rows = "";
            
            state.ll5s.forEach((ll5, ll5Idx) => {
                ll5.ll6s.forEach((ll6, ll6Idx) => {
                    const entries = state.entries.filter(e => e.ll6 === ll6.name && e.weekKey === weekKey);
                    const totals = [0,0,0,0,0,0,0];
                    const cost = entries.reduce((s, e) => {
                        e.hrs.forEach((h, i) => totals[i] += h);
                        return s + e.cost;
                    }, 0);

                    if (cost === 0) return;

                    const safeID = (ll5.name + ll6.name).replace(/[^a-z0-9]/gi, '');

                    rows += `
                        <tr class="border-b border-slate-50 hover:bg-slate-50/30 transition cursor-pointer" onclick="toggleEmpRows('${safeID}')">
                            <td class="p-4 whitespace-nowrap">
                                <p class="text-sm font-black text-slate-800">${ll6.name} ${entries.length > 0 ? '▾' : ''}</p>
                                <p class="text-[10px] font-bold text-slate-400">LL5: ${ll5.name}</p>
                            </td>
                            ${totals.map(t => `<td class="p-4 text-center"><span class="px-2 py-1 rounded-lg text-xs font-black ${t > 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-50 text-slate-300'}">${t}</span></td>`).join('')}
                            <td class="p-4 text-right font-black text-[#003478]">$${cost.toLocaleString()}</td>
                        </tr>
                    `;

                    entries.forEach((e, idx) => {
                        const globalIdx = state.entries.indexOf(e);
                        rows += `
                            <tr class="emp-row-${safeID} hidden border-b border-slate-50 bg-slate-50/50">
                                <td class="p-4 pl-10 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span>↳ ${e.emp}</span>
                                        <div class="relative group inline">
                                            <span class="cursor-help text-[#0060b6] font-bold">ⓘ</span>
                                            <div class="hidden group-hover:block absolute bg-slate-800 text-white text-xs rounded p-2 z-50 whitespace-nowrap top-0 left-6 shadow-lg">
                                                <div class="font-bold text-amber-300">Program: ${e.prog || 'N/A'}</div>
                                                <div class="font-bold text-amber-300">Location: ${e.loc || 'N/A'}</div>
                                                <div class="font-bold text-amber-300">Reason: ${e.reason || 'N/A'}</div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                ${e.hrs.map(h => `<td class="p-4 text-center text-xs text-slate-500">${h}</td>`).join('')}
                                <td class="p-4 text-right text-xs text-slate-500">$${e.cost.toLocaleString()}</td>
                            </tr>
                        `;
                    });
                });
            });

            container.innerHTML = rows ? `
                <table class="w-full text-left">
                    <thead><tr class="bg-slate-50/50"><th class="p-4 text-[10px] font-black text-slate-400 uppercase">Supervisor</th>${DAYS.map(d => `<th class="p-4 text-center text-[10px] font-black text-slate-400">${d}</th>`).join('')}<th class="p-4 text-right text-[10px] font-black text-slate-400 uppercase">Total</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            ` : `<div class="p-10 text-center text-slate-400 font-bold text-sm">No data for this week.</div>`;
        }

        function switchView(view) {
            document.getElementById('view-worksheet').classList.toggle('hidden', view !== 'worksheet');
            document.getElementById('view-settings').classList.toggle('hidden', view !== 'settings');
            document.getElementById('header-nav').classList.toggle('hidden', view !== 'worksheet');
            
            // Icon color toggle
            const navs = document.querySelectorAll('nav button');
            navs[0].className = `flex flex-col items-center gap-1 ${view === 'worksheet' ? 'text-[#003478]' : 'text-slate-400'}`;
            navs[1].className = `flex flex-col items-center gap-1 ${view === 'settings' ? 'text-[#003478]' : 'text-slate-400'}`;
            
            if (view === 'settings') renderSettings();
        }

        function openModal() { document.getElementById('entry-modal').classList.remove('modal-hidden'); }
        function closeModal() { document.getElementById('entry-modal').classList.add('modal-hidden'); }

        function populateDropdowns() {
            const l5 = document.getElementById('sel-ll5');
            l5.innerHTML = state.ll5s.map(x => `<option value="${x.name}">${x.name}</option>`).join('');
            updateLL6Dropdown();
        }

        function updateLL6Dropdown() {
            const ll5 = state.ll5s.find(l => l.name === document.getElementById('sel-ll5').value);
            document.getElementById('sel-ll6').innerHTML = ll5 ? ll5.ll6s.map(x => `<option value="${x.name}">${x.name}</option>`).join('') : '';
            updateEmployeeDropdown();
        }

        function updateEmployeeDropdown() {
            const ll5 = state.ll5s.find(l => l.name === document.getElementById('sel-ll5').value);
            const ll6 = ll5 ? ll5.ll6s.find(l => l.name === document.getElementById('sel-ll6').value) : null;
            document.getElementById('sel-emp').innerHTML = ll6 ? ll6.employees.map(x => `<option value="${x}">${x}</option>`).join('') : '';
        }

        function addEntry() {
            const week = getWeekData(state.viewOffset);
            const hrs = [];
            let total = 0;
            for(let i=0; i<7; i++) {
                const val = parseFloat(document.getElementById(`hrs-${i}`).value || 0);
                hrs.push(val); total += val;
            }
            if (total === 0) return alert("Enter hours");

            state.entries.push({
                weekKey: week.key,
                ll5: document.getElementById('sel-ll5').value,
                ll6: document.getElementById('sel-ll6').value,
                emp: document.getElementById('sel-emp').value,
                prog: document.getElementById('in-prog').value || "Default",
                loc: document.getElementById('in-loc').value || "N/A",
                reason: document.getElementById('in-reason').value || "N/A",
                cost: total * state.rate * 1.5,
                hrs
            });

            save(); refreshUI(); closeModal();
            for(let i=0; i<7; i++) document.getElementById(`hrs-${i}`).value = 0;
            document.getElementById('in-prog').value = "";
            document.getElementById('in-loc').value = "";
            document.getElementById('in-reason').value = "";
        }

        function addYearBudget() {
            const y = document.getElementById('set-new-year').value;
            const b = document.getElementById('set-new-budget').value;
            if(y && b) { 
                state.budgetsByYear[y] = parseFloat(b);
                // Initialize week start date for new year if not set
                if (!state.weekStartDates[y]) {
                    state.weekStartDates[y] = `${y}-01-01`;
                }
                document.getElementById('set-new-year').value = '';
                document.getElementById('set-new-budget').value = '';
                save(); 
                renderSettings(); 
            }
        }

        function removeYearBudget(yr) {
            if (confirm(`Delete budget for ${yr}?`)) {
                delete state.budgetsByYear[yr];
                save();
                renderSettings();
            }
        }

        function renderSettings() {
            const yearSel = document.getElementById('settings-year-selector');
            yearSel.innerHTML = Object.keys(state.budgetsByYear).sort().map(y => 
                `<option value="${y}">${y}</option>`
            ).join('');
            updateBudgetForm();
            renderHierarchy();
        }

        function updateBudgetForm() {
            const year = document.getElementById('settings-year-selector').value;
            const budgetInput = document.getElementById('settings-budget-input');
            const weekStartInput = document.getElementById('settings-week-start');
            
            budgetInput.value = state.budgetsByYear[year] || 0;
            weekStartInput.value = state.weekStartDates[year] || `${year}-01-01`;
        }

        function saveBudgetForYear() {
            const year = document.getElementById('settings-year-selector').value;
            const budget = parseFloat(document.getElementById('settings-budget-input').value) || 0;
            const weekStart = document.getElementById('settings-week-start').value;
            
            state.budgetsByYear[year] = budget;
            state.weekStartDates[year] = weekStart;
            save();
            populateWorksheetYearSelector();
            refreshUI();
        }

        function addNewYear() {
            const yearInput = document.getElementById('new-year-input');
            const year = yearInput.value.trim();
            
            if (!year) {
                alert('Please enter a year');
                return;
            }
            
            if (state.budgetsByYear[year]) {
                alert(`Year ${year} already exists`);
                return;
            }
            
            state.budgetsByYear[year] = 1000000; // Default budget
            state.weekStartDates[year] = `${year}-01-01`; // Default start date
            yearInput.value = '';
            save();
            renderSettings();
            document.getElementById('settings-year-selector').value = year;
            updateBudgetForm();
        }

        function renderHierarchy() {
            document.getElementById('settings-hierarchy').innerHTML = state.ll5s.map((ll5, ll5Idx) => `
                <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <div class="bg-[#003478] text-white p-3 flex justify-between items-center">
                        <div class="flex-1">
                            <p class="font-black">${ll5.name}</p>
                            <p class="text-xs opacity-75">${ll5.ll6s.length} supervisor(s)</p>
                        </div>
                        <button onclick="editLL5Name(${ll5Idx})" class="text-yellow-300 hover:text-white font-bold px-2">✎</button>
                        <button onclick="removeLL5(${ll5Idx})" class="text-red-300 hover:text-white font-bold text-xl px-2">×</button>
                    </div>
                    
                    <div class="p-3 bg-slate-50 space-y-2">
                        ${ll5.ll6s.map((ll6, ll6Idx) => `
                            <div class="bg-white border-l-4 border-[#0060b6] p-3 rounded">
                                <div class="flex justify-between items-center mb-2">
                                    <p class="font-bold text-slate-700">${ll6.name}</p>
                                    <div class="flex gap-1">
                                        <button onclick="editLL6Name(${ll5Idx}, ${ll6Idx})" class="text-blue-500 hover:text-blue-700 text-xs font-bold">✎</button>
                                        <button onclick="removeLL6(${ll5Idx}, ${ll6Idx})" class="text-red-500 hover:text-red-700 text-xs font-bold">✕</button>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-500 mb-2">${ll6.employees.length} employee(s)</div>
                                <div class="space-y-1 mb-2">
                                    ${ll6.employees.map((emp, empIdx) => `
                                        <div class="flex justify-between items-center text-xs bg-slate-100 p-2 rounded">
                                            <span>↳ ${emp}</span>
                                            <div class="flex gap-1">
                                                <button onclick="editEmployee(${ll5Idx}, ${ll6Idx}, ${empIdx})" class="text-blue-500 hover:text-blue-700 font-bold text-xs">✎</button>
                                                <button onclick="removeEmployee(${ll5Idx}, ${ll6Idx}, ${empIdx})" class="text-red-500 hover:text-red-700 font-bold text-xs">×</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="new-emp-${ll5Idx}-${ll6Idx}" placeholder="Add employee" class="flex-1 p-2 bg-white border border-slate-200 rounded text-xs">
                                    <button onclick="addEmployee(${ll5Idx}, ${ll6Idx})" class="bg-emerald-500 text-white px-3 rounded text-xs font-bold">+</button>
                                </div>
                            </div>
                        `).join('')}
                        
                        <div class="flex gap-2 mt-2">
                            <input type="text" id="new-ll6-${ll5Idx}" placeholder="Add supervisor" class="flex-1 p-2 bg-white border border-slate-200 rounded text-xs">
                            <button onclick="addLL6(${ll5Idx})" class="bg-blue-500 text-white px-3 rounded text-xs font-bold">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editLL5Name(ll5Idx) {
            const newName = prompt(`Edit manager name:`, state.ll5s[ll5Idx].name);
            if (newName && newName.trim()) {
                state.ll5s[ll5Idx].name = newName.trim();
                save();
                renderHierarchy();
                populateDropdowns();
            }
        }

        function editLL6Name(ll5Idx, ll6Idx) {
            const newName = prompt(`Edit supervisor name:`, state.ll5s[ll5Idx].ll6s[ll6Idx].name);
            if (newName && newName.trim()) {
                state.ll5s[ll5Idx].ll6s[ll6Idx].name = newName.trim();
                save();
                renderHierarchy();
                populateDropdowns();
            }
        }

        function editEmployee(ll5Idx, ll6Idx, empIdx) {
            const newName = prompt(`Edit employee name:`, state.ll5s[ll5Idx].ll6s[ll6Idx].employees[empIdx]);
            if (newName && newName.trim()) {
                state.ll5s[ll5Idx].ll6s[ll6Idx].employees[empIdx] = newName.trim();
                save();
                renderHierarchy();
                populateDropdowns();
            }
        }

        function setWeek1StartDate(year) {
            const dateInput = document.getElementById(`week-start-${year}`).value;
            if (dateInput) {
                state.weekStartDates[year] = dateInput;
                save();
                refreshUI();
                populateJumpSelectors();
            }
        }

        function addLL6(ll5Idx) {
            const name = document.getElementById(`new-ll6-${ll5Idx}`).value;
            if (!name) return;
            state.ll5s[ll5Idx].ll6s.push({ name, employees: [] });
            document.getElementById(`new-ll6-${ll5Idx}`).value = '';
            save();
            renderSettings();
            populateDropdowns();
        }

        function removeLL6(ll5Idx, ll6Idx) {
            if (confirm(`Remove ${state.ll5s[ll5Idx].ll6s[ll6Idx].name}?`)) {
                state.ll5s[ll5Idx].ll6s.splice(ll6Idx, 1);
                save();
                renderSettings();
                populateDropdowns();
            }
        }

        function addEmployee(ll5Idx, ll6Idx) {
            const name = document.getElementById(`new-emp-${ll5Idx}-${ll6Idx}`).value;
            if (!name) return;
            state.ll5s[ll5Idx].ll6s[ll6Idx].employees.push(name);
            document.getElementById(`new-emp-${ll5Idx}-${ll6Idx}`).value = '';
            save();
            renderSettings();
            populateDropdowns();
        }

        function removeEmployee(ll5Idx, ll6Idx, empIdx) {
            if (confirm(`Remove ${state.ll5s[ll5Idx].ll6s[ll6Idx].employees[empIdx]}?`)) {
                state.ll5s[ll5Idx].ll6s[ll6Idx].employees.splice(empIdx, 1);
                save();
                renderSettings();
                populateDropdowns();
            }
        }

        function addLL5() {
            const name = document.getElementById('new-ll5').value;
            if (!name) return;
            state.ll5s.push({ name, ll6s: [] });
            document.getElementById('new-ll5').value = '';
            save();
            renderSettings();
            populateDropdowns();
        }

        function removeLL5(ll5Idx) {
            if (confirm(`Remove ${state.ll5s[ll5Idx].name}?`)) {
                state.ll5s.splice(ll5Idx, 1);
                save();
                renderSettings();
                populateDropdowns();
            }
        }

        function toggleEmpRows(className) {
            document.querySelectorAll(`.emp-row-${className}`).forEach(r => r.classList.toggle('hidden'));
        }

        function populateJumpSelectors() {
            const yrSel = document.getElementById('jump-year');
            const wkSel = document.getElementById('jump-week');
            const currentYear = new Date().getFullYear();
            const week = getWeekData(state.viewOffset);

            // Only populate years if empty
            if (yrSel.options.length === 0) {
                for(let y = currentYear - 2; y <= currentYear + 3; y++) {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.text = y;
                    yrSel.appendChild(opt);
                }
                yrSel.addEventListener('change', updateWeeksDropdown);
            }

            // Update week dropdown when year changes
            updateWeeksDropdown();

            // Always update current values
            yrSel.value = week.year;
            wkSel.value = week.weekNum;
        }

        function updateWeeksDropdown() {
            const wkSel = document.getElementById('jump-week');
            const selectedYear = parseInt(document.getElementById('jump-year').value);
            
            // Clear weeks dropdown
            wkSel.innerHTML = '';
            
            // Calculate max weeks for this year
            let week1Start;
            if (state.weekStartDates[selectedYear]) {
                const parts = state.weekStartDates[selectedYear].split('-');
                week1Start = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            } else {
                week1Start = new Date(selectedYear, 0, 1);
            }
            const yearEnd = new Date(selectedYear, 11, 31);
            const daysDiff = Math.floor((yearEnd - week1Start) / 86400000);
            const maxWeeks = Math.floor(daysDiff / 7) + 1;
            
            // Populate weeks for this year
            for(let w = 1; w <= maxWeeks; w++) {
                const opt = document.createElement('option');
                opt.value = w;
                opt.text = `Week ${w}`;
                wkSel.appendChild(opt);
            }
        }

        function jumpToWeek() {
            const targetYear = parseInt(document.getElementById('jump-year').value);
            const targetWeek = parseInt(document.getElementById('jump-week').value);
            
            let week1Start;
            if (state.weekStartDates[targetYear]) {
                const parts = state.weekStartDates[targetYear].split('-');
                week1Start = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            } else {
                week1Start = new Date(targetYear, 0, 1);
            }
            
            const targetSunday = new Date(week1Start);
            targetSunday.setDate(week1Start.getDate() + ((targetWeek - 1) * 7));
            
            const today = new Date();
            const currentSunday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            currentSunday.setDate(currentSunday.getDate() - currentSunday.getDay());
            
            state.viewOffset = Math.round((targetSunday - currentSunday) / (86400000 * 7));
            refreshUI();
        }

        function changeWeek(dir) { 
            const currentWeek = getWeekData(state.viewOffset);
            const nextWeek = getWeekData(state.viewOffset + dir);
            
            const year = nextWeek.year;
            let week1Start;
            if (state.weekStartDates[year]) {
                const parts = state.weekStartDates[year].split('-');
                week1Start = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            } else {
                week1Start = new Date(year, 0, 1);
            }
            const yearEnd = new Date(year, 11, 31);
            
            // Check if trying to go before Week 1 start
            if (nextWeek.sun < week1Start) {
                return; // Don't allow going before Week 1
            }
            
            // Check if trying to go past end of year (allow one week for partial weeks)
            if (nextWeek.sun > yearEnd) {
                return; // Don't allow going past year end
            }
            
            state.viewOffset += dir; 
            refreshUI(); 
        }
        
        function save() { 
            state.rate = parseFloat(document.getElementById('set-rate').value) || 0;
            localStorage.setItem('ford_ot_v3_mobile', JSON.stringify(state)); 
            refreshUI();
        }

        init();
    </script>
</body>
</html>
